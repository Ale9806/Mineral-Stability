---
title: "K Feldspar Weathering"
output:
  html_document:
    css: stylesheet.css
    fig_caption: yes
    number_sections: no
    toc: yes
    toc_float: true
    toc_depth: 3
    code_folding: show
    df_print: paged
subtitle: "Source file: weathering_pset.Rmd"
editor_options:
  chunk_output_type: console
date: "`r Sys.Date()`"
---

# Introduction
In this R markdown file, we calculate and visualize changes in water chemistry and secondary mineral assemblages as microcline (potassium feldspar) reacts with a typical acidic soil water.

Our calculations are adapted from the model of Steinmann et al., 1994 (http://ccm.geoscienceworld.org/content/42/2/197), which were based the following assumptions:

1. The system is closed and the water/rock ratio is small.
2. The secondary minerals are in equilibrium with ions in the solution even though the primary minerals are not in equilibrium.
3. Temperature and pressure are constant.
4. Aluminum is conserved in the reactions.
5. The solutions remain dilute such that all activity coefficients are close to unity.

# Setup

```{r setup, warning=FALSE, message=FALSE}
# load libraries
library(tidyverse) # dplyr, tidyr, ggplot
library(openxlsx) # reading and writing excel file
library(knitr) # generating reports
library(plotly) # interactive plots
library(CHNOSZ) # stability diagrams
library(latex2exp) # writing compounds and greek letters in plots
data(thermo)
opts_chunk$set(
  collapse = TRUE, comment = "#>",
  dev=c("png", "pdf"), dev.args=list(pdf = list(encoding="WinAnsi", useDingbats=FALSE))
  )
```

# Mineral stability diagram K$_2$O - Al$_2$O$_3$ - SiO$_2$ - H$_2$O system
The weathering reactions we will discuss are based on varying water chemical compositions within the mineral stability diagram plotted below.

```{r fig.width=10, fig.height=10, warning=FALSE, error=FALSE}
par(mfrow = c(2, 2))
res <- 200
fill <- "terrain"

## K2O-Al2O3-SiO2-H2O, 25 degree C, 1 bar
## Steinmann et al., 1994 (http://ccm.geoscienceworld.org/content/42/2/197)
## Garrels and Christ, p. 361 (http://www.worldcat.org/oclc/517586)
## https://wwwbrr.cr.usgs.gov/projects/GWC_coupled/phreeqc/html/final-75.html
basis(c("Al+3", "pseudo-H4SiO4", "K+", "H2O", "H+", "O2"))
species(c("gibbsite", "muscovite", "kaolinite", "pyrophyllite", "K-feldspar"))
a <- affinity(H4SiO4 = c(-6, -2, res), `K+` = c(-3, 6, res))
diagram(a, ylab = ratlab("K+"), fill = fill, yline = 1.7)
title(main = syslab(c("K2O", "Al2O3", "SiO2", "H2O")))
legend("bottomleft", describe.property(c("T", "P"), c(25, 1)), bty = "n")
```


# Reaction 1: K feldspar weathering to gibbsite

KAlSi$_3$O$_8$ + H$^+$ + 7H$_2$O $\leftrightharpoons$ Al(OH)$_3$ + 2K$^+$ + 3H$_4$SiO$_4$

Initial conditions, reaction 1
```{r}
#initial conditions are no secondary minerals (only primary mineral, microcline), and water chemistry of typical acidic soil
mol_gibbs_A <- 0 # moles gibbsite at t0
mol_l_H_A <- 1e-4 # moles per liter H+ t0
mol_l_K_A <- 1e-6 # moles per liter K+ t0
mol_l_H4SiO4_A <- 1e-6 # moles per liter H4SiO4 t0 
mol_kaol_A <- 0 # moles kaolinite t0
mol_musc_A <- 0 # moles muscovite t0

rxn_prog_var <- 7.47e-7 # reaction progress variable is proportional to the amount of reactant mineral dissolved and defines the extent of reaction. Selection of reaction progress step is arbitrary. units are moles per kg of solution

#coefficients of change for weathering of k spar to gibbsite (reaction 1)
co_spar_1 <- -1
co_H_1 <- -1
co_H2O_1 <- -7
co_gibbs_1 <- 1
co_K_1 <- 1
co_H4SiO4_1 <- 3
co_kaol_1 <- 0
co_musc_1 <- 0
```

Make data frame of reaction steps
```{r}
steps <- seq(0, 26, by = 0.01) # make a sequence of reaction steps

k_spar_to_gibbs <- as.data.frame(steps) # convert sequence to a data frame
```

Calculate geochemistry through reaction progress
```{r}
k_spar_to_gibbs <- k_spar_to_gibbs %>% mutate(mol_l_H = mol_l_H_A + co_H_1 * steps * rxn_prog_var, mol_l_K = mol_l_K_A + co_K_1 * steps * rxn_prog_var, mol_l_H4SiO4 = mol_l_H4SiO4_A + co_H4SiO4_1 * steps * rxn_prog_var, mol_gibbs = mol_gibbs_A + co_gibbs_1 * steps * rxn_prog_var, mol_kaol = mol_kaol_A + co_kaol_1 * steps * rxn_prog_var, mol_musc = mol_musc_A + co_musc_1 * steps * rxn_prog_var, log_H4SiO4 = log10(mol_l_H4SiO4), log_K_H_ratio = log10(mol_l_K/mol_l_H))
```

Plot evolution of water chemistry during k feldspar weathering to gibbsite
```{r fig.height=6, fig.width=6}
plot_k_spar_to_gibbs <- k_spar_to_gibbs %>% ggplot(aes(x=log_H4SiO4, y = log_K_H_ratio, color = steps))+
  geom_point() +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
  scale_color_continuous(name = TeX("rxn progress, $\\xi$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))+
  annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)

plot_k_spar_to_gibbs
```


#  Reaction 2: K feldspar weathering, gibbsite converted to kaolinite

KAlSi$_3$O$_8$ + 2Al(OH)$_3$ + H$^+$  $\leftrightharpoons$ 1.5Al$_2$Si$_2$O$_5$(OH)$_4$ + K$^+$ + 0.5H$_2$O

Initial conditions, reaction 2
```{r}
mol_gibbs_B <- k_spar_to_gibbs$mol_gibbs[2601] # moles gibbsite at end of reaction 1 (point B)
mol_l_H_B <-  k_spar_to_gibbs$mol_l_H[2601] # moles per liter H+ at end of reaction 1 (point B)
mol_l_K_B <- k_spar_to_gibbs$mol_l_K[2601] # moles per liter K+ at end of reaction 1 (point B)
mol_l_H4SiO4_B <- k_spar_to_gibbs$mol_l_H4SiO4[2601] # moles per liter H4SiO4 at end of reaction 1 (point B)
mol_kaol_B <- k_spar_to_gibbs$mol_kaol[2601]# moles kaolinite at end of reaction 1 (point B)
mol_musc_B <- k_spar_to_gibbs$mol_musc[2601]# moles muscovite at end of reaction 1 (point B)

#coefficients of change for weathering of k spar with conversion of gibbsite to kaolinite (reaction 2)
co_spar_2 <- -1
co_H_2 <- -1
co_H2O_2 <- 0.5
co_gibbs_2 <- -2
co_K_2 <- 1
co_H4SiO4_2 <- 0
co_kaol_2 <- 1.5
co_musc_2 <- 0
```

Make data frame of reaction steps
```{r}
steps_2 <- seq(0, 20, by = 0.01)

gibbs_to_kaol <- as.data.frame(steps_2)

gibbs_to_kaol <- gibbs_to_kaol %>% mutate(steps = steps_2 + 26)
```

Calculate geochemistry through reaction progress
```{r}
gibbs_to_kaol <- gibbs_to_kaol %>% mutate(mol_l_H = mol_l_H_B + co_H_2 * steps_2 * rxn_prog_var, mol_l_K = mol_l_K_B + co_K_2 * steps_2 * rxn_prog_var, mol_l_H4SiO4 = mol_l_H4SiO4_B + co_H4SiO4_2 * steps_2 * rxn_prog_var, mol_gibbs = mol_gibbs_B + co_gibbs_2 * steps_2 * rxn_prog_var, mol_kaol = mol_kaol_B + co_kaol_2 * steps_2 * rxn_prog_var, mol_musc = mol_musc_B + co_musc_2 * steps_2 * rxn_prog_var, log_H4SiO4 = log10(mol_l_H4SiO4), log_K_H_ratio = log10(mol_l_K/mol_l_H))
```

Merge data frames for reactions 1 and 2
```{r}
gibbs_to_kaol <- gibbs_to_kaol %>% select(-steps_2)

gibbs_to_kaol <- gibbs_to_kaol %>% filter(mol_gibbs >= 0) # filter out data points where there were calculated to be negative moles gibbsite, which is impossible

reactions_1_2 <- union(k_spar_to_gibbs, gibbs_to_kaol)

```

Plot evolution of water chemistry during weathering of k feldspar with conversion of gibbsite to kaolinite (reaction 2)
```{r fig.height=6, fig.width=6}
plot_reactions_1_2 <- reactions_1_2 %>% ggplot(aes(x=log_H4SiO4, y = log_K_H_ratio, color = steps, label = mol_l_K))+
  geom_point() +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11)) +
  scale_color_continuous(name = TeX("rxn progress, $\\xi$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))+
  annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)+
  annotate("text", y = 0, x=-4.4, label = "C", size = 6)

plot_reactions_1_2
```

Plot accumulation of minerals with reaction progress
```{r fig.height=6, fig.width=6}
plot_minerals_rxns_1_2 <- reactions_1_2 %>% ggplot()+
  geom_point(aes(x=steps, y=mol_musc, color = "moles muscovite"))+
  geom_point(aes(x=steps, y=mol_gibbs, color = "moles gibbsite"))+
  geom_point(aes(x=steps, y=mol_kaol, color = "moles kaolinite"))+
  scale_y_continuous(name = "moles mineral in system")+
  scale_x_continuous(name = TeX("reaction progress, $\\xi$"))+
  theme_bw()

plot_minerals_rxns_1_2
```

# Reaction 3: K feldspar weathering to kaolinite

2KAlSi$_3$O$_8$ + 2H$^+$ + 9H$_2$O $\leftrightharpoons$ Al$_2$Si$_2$O$_5$(OH)$_4$ + 2K$^+$ + 4H$_4$SiO$_4$

Initial conditions, reaction 3
```{r}
mol_gibbs_C <- gibbs_to_kaol$mol_gibbs[1301] # moles gibbsite at end of reaction 2 (point C)
mol_l_H_C <-  gibbs_to_kaol$mol_l_H[1301] # moles per liter H+ at end of reaction 2 (point C)
mol_l_K_C <- gibbs_to_kaol$mol_l_K[1301] # moles per liter K+ at end of reaction 2 (point C)
mol_l_H4SiO4_C <- gibbs_to_kaol$mol_l_H4SiO4[1301] # moles per liter H4SiO4 at end of reaction 2 (point C)
mol_kaol_C <- gibbs_to_kaol$mol_kaol[1301] # moles kaolinite  at end of reaction 2 (point C)
mol_musc_C <- gibbs_to_kaol$mol_musc[1301] # moles muscovite  at end of reaction 2 (point C)

#coefficients of change for weathering of k spar to kaolinite (reaction 3)
co_spar_3 <- -2
co_H_3 <- -2
co_H2O_3 <- -9
co_gibbs_3 <- 0
co_K_3 <- 2
co_H4SiO4_3 <- 4
co_kaol_3 <- 1
co_musc_3 <- 0
```

Make data frame of reaction steps
```{r}
steps_3 <- seq(0, 100, by = 0.01)

kspar_to_kaol <- as.data.frame(steps_3)

kspar_to_kaol <- kspar_to_kaol %>% mutate(steps = steps_3 + 39)
```

Calculate geochemistry through reaction progress
```{r}
kspar_to_kaol <- kspar_to_kaol %>% mutate(mol_l_H = mol_l_H_C + co_H_3 * steps_3 * rxn_prog_var, mol_l_K = mol_l_K_C + co_K_3 * steps_3 * rxn_prog_var, mol_l_H4SiO4 = mol_l_H4SiO4_C + co_H4SiO4_3 * steps_3 * rxn_prog_var, mol_gibbs = mol_gibbs_C + co_gibbs_3 * steps_3 * rxn_prog_var, mol_kaol = mol_kaol_C + co_kaol_3 * steps_3 * rxn_prog_var, mol_musc = mol_musc_C + co_musc_3 * steps_3 * rxn_prog_var, log_H4SiO4 = log10(mol_l_H4SiO4), log_K_H_ratio = log10(mol_l_K/mol_l_H))
```

Merge data frames for reactions 1 and 2
```{r}
kspar_to_kaol <- kspar_to_kaol %>% select(-steps_3)
kspar_to_kaol <- kspar_to_kaol %>% filter(mol_l_K <= 1.01e-4) # filter out rxn steps past equilibrium

reactions_1_2_3 <- union(reactions_1_2, kspar_to_kaol)
```

Plot evolution of water chemistry during weathering of k feldspar to kaolinite (reaction 3)
```{r}
plot_reactions_1_2_3 <- reactions_1_2_3 %>% ggplot(aes(x=log_H4SiO4, y = log_K_H_ratio, color = steps, label = mol_l_K))+
  geom_point() +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11)) +
  scale_color_continuous(name = TeX("rxn progress, $\\xi$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))+
  annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)+
  annotate("text", y = 0, x=-4.4, label = "C", size = 6)+
  annotate("text", y = 4.4, x=-3.9, label = "D", size = 6)

plot_reactions_1_2_3
```

Plot accumulation of minerals with reactions 1 through 3
```{r fig.height=6, fig.width=6}
plot_minerals_rxns_1_2_3 <- reactions_1_2_3 %>% ggplot()+
  geom_point(aes(x=steps, y=mol_musc, color = "moles muscovite"))+
  geom_point(aes(x=steps, y=mol_gibbs, color = "moles gibbsite"))+
  geom_point(aes(x=steps, y=mol_kaol, color = "moles kaolinite"))+
  scale_y_continuous(name = "moles mineral in system")+
  scale_x_continuous(name = TeX("reaction progress, $\\xi$"))+
  theme_bw()

plot_minerals_rxns_1_2_3
```

# Reaction 4: K feldspar weathering with conversion of kaolinite to muscovite, reaching equilibrium between all 3 minerals

KAlSi$_3$O$_8$ + Al$_2$Si$_2$O$_5$(OH)$_4$ + 3H$_2$O $\leftrightharpoons$ KAl$_3$Si$_3$O$_{10}$(OH)$_2$ + 2H$_4$SiO$_4$

Initial conditions, reaction 4
```{r}
mol_gibbs_D <- kspar_to_kaol$mol_gibbs[4744] # moles gibbsite at end of reaction 3 (point D)
mol_l_H_D <-  kspar_to_kaol$mol_l_H[4744] # moles per liter H+ at end of reaction 3 (point D)
mol_l_K_D <- kspar_to_kaol$mol_l_K[4744] # moles per liter K+ at end of reaction 3 (point D)
mol_l_H4SiO4_D <- kspar_to_kaol$mol_l_H4SiO4[4744] # moles per liter H4SiO4 at end of reaction 3 (point D)
mol_kaol_D <- kspar_to_kaol$mol_kaol[4744] # moles kaolinite  at end of reaction 3 (point D)
mol_musc_D <- kspar_to_kaol$mol_musc[4744] # moles muscovite  at end of reaction 3 (point D)

#coefficients of change for feldspar weathering with conversion of kaolinite to muscovite (reaction 4)
co_spar_4 <- -1
co_H_4 <- 0
co_H2O_4 <- -3
co_gibbs_4 <- 0
co_K_4 <- 0
co_H4SiO4_4 <- 2
co_kaol_4 <- -1
co_musc_4 <- 1
```

Make data frame of reaction steps
```{r}
steps_4 <- seq(0, 30, by = 0.01)

kspar_to_musc <- as.data.frame(steps_4)

kspar_to_musc <- kspar_to_musc %>% mutate(steps = steps_4 + 86.39)
```

Calculate geochemistry through reaction progress
```{r}
kspar_to_musc <- kspar_to_musc %>% mutate(mol_l_H = mol_l_H_D + co_H_4 * steps_4 * rxn_prog_var, mol_l_K = mol_l_K_D + co_K_4 * steps_4 * rxn_prog_var, mol_l_H4SiO4 = mol_l_H4SiO4_D + co_H4SiO4_4 * steps_4 * rxn_prog_var, mol_gibbs = mol_gibbs_D + co_gibbs_4 * steps_4 * rxn_prog_var, mol_kaol = mol_kaol_D + co_kaol_4 * steps_4 * rxn_prog_var, mol_musc = mol_musc_D + co_musc_4 * steps_4 * rxn_prog_var, log_H4SiO4 = log10(mol_l_H4SiO4), log_K_H_ratio = log10(mol_l_K/mol_l_H))
```

Merge data frames for reactions 1, 2, 3, and 4
```{r}
kspar_to_musc <- kspar_to_musc %>% select(-steps_4)
kspar_to_musc <- kspar_to_musc %>% filter(steps <= 100) # filter out rxn steps past equilibrium

reactions_1_2_3_4 <- union(reactions_1_2_3, kspar_to_musc)
```

Plot evolution of water chemistry during K feldspar weathering with conversion of kaolinite to muscovite, reaching equilibrium between all 3 minerals
```{r}
plot_reactions_1_2_3_4 <- reactions_1_2_3_4 %>% ggplot(aes(x=log_H4SiO4, y = log_K_H_ratio, color = steps, label = mol_l_K))+
  geom_point() +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11)) +
  scale_color_continuous(name = TeX("rxn progress, $\\xi$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))+
  annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)+
  annotate("text", y = 0, x=-4.4, label = "C", size = 6)+
  annotate("text", y = 4.4, x=-3.9, label = "D", size = 6)+
  annotate("text", y = 4.4, x=-3.5, label = "E", size = 6)

plot_reactions_1_2_3_4
```

Plot accumulation of minerals with reactions 1 through 4
```{r fig.height=6, fig.width=6}
plot_minerals_rxns_1_2_3_4 <- reactions_1_2_3_4 %>% ggplot()+
  geom_point(aes(x=steps, y=mol_musc, color = "moles muscovite"))+
  geom_point(aes(x=steps, y=mol_gibbs, color = "moles gibbsite"))+
  geom_point(aes(x=steps, y=mol_kaol, color = "moles kaolinite"))+
  scale_y_continuous(name = "moles mineral in system")+
  scale_x_continuous(name = TeX("reaction progress, $\\xi$"))+
  theme_bw()

plot_minerals_rxns_1_2_3_4
```

