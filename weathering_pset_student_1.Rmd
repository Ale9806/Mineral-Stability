---
title: "K Feldspar Weathering"
output:
  html_document:
    css: stylesheet.css
    fig_caption: yes
    number_sections: no
    toc: yes
    toc_float: true
    toc_depth: 3
    code_folding: show
    df_print: paged
subtitle: "Source file: weathering_pset.Rmd"
editor_options:
  chunk_output_type: inline
date: "`r Sys.Date()`"
---

# Introduction
In this R markdown file, we calculate and visualize changes in water chemistry and secondary mineral assemblages as the igneous _primary mineral_ microcline (a form of potassium feldspar) reacts with a typical, mildly acidic soil water.

Mineral stability diagrams describe which minerals are stable given a specific water chemistry. When a mineral is unstable it is a _reactant_ that will _weather_ into a _product_, also known as a _secondary mineral_. 
The first step in using a mineral stability digram is making said mineral stability digram. The lines on the mineral stability digram describe regions where the two minerals are in equilibrium. 

The x-axis of the diagram is log[H4SiO4], which is silicic acid. The Y-axis in this case will be log [K+]/[H+]. While the X-axis will always be silicic acid, the Y-axis can have different cations depending on the mineral system of interest.
The equations that we will use are listed below
**list all the equations along with the gibbs or just give them the Keq**

# Question 1) Using these equations, write out the equations that will make up the mineral phase diagram. Turn these equations in along with your work.

**This is where they should do all the equation work. Potential here to add in an example, or potential here to instead have them answer questions like which one has a nevative slope, which one has a positive slope, or which one is a flat line... etc. **



Now that you have successfully derived the equations necessary for the mineral phase diagram, we will use Rstudio to build the mineral phase diagram.

Our calculations are adapted from the model of Steinmann et al., 1994 (http://ccm.geoscienceworld.org/content/42/2/197), which were based the following assumptions:

1. The system is closed and the water/rock ratio is small.
2. The secondary minerals are in equilibrium with ions in the solution even though the primary minerals are not in equilibrium.
3. Temperature and pressure are constant.
4. Aluminum is conserved in the reactions.
5. The solutions remain dilute such that all activity coefficients are close to unity.


# Setup

```{r setup, warning=FALSE, message=FALSE}
# load libraries
library(tidyverse) # dplyr, tidyr, ggplot
library(openxlsx) # reading and writing excel file
library(knitr) # generating reports
library(plotly) # interactive plots
library(CHNOSZ) # stability diagrams
library(latex2exp) # writing compounds and greek letters in plots
data(thermo)
opts_chunk$set(
  collapse = TRUE, comment = "#>",
  dev=c("png", "pdf"), dev.args=list(pdf = list(encoding="WinAnsi", useDingbats=FALSE))
  )
```

# Mineral stability diagram K$_2$O - Al$_2$O$_3$ - SiO$_2$ - H$_2$O system
The weathering reactions we will discuss are based on varying water chemical compositions within the mineral stability diagram plotted below.

```{r fig.width=10, fig.height=10, warning=FALSE, error=FALSE}
par(mfrow = c(2, 2))
res <- 200
fill <- "terrain"

## K2O-Al2O3-SiO2-H2O, 25 degree C, 1 bar
## Steinmann et al., 1994 (http://ccm.geoscienceworld.org/content/42/2/197)
## Garrels and Christ, p. 361 (http://www.worldcat.org/oclc/517586)
## https://wwwbrr.cr.usgs.gov/projects/GWC_coupled/phreeqc/html/final-75.html
basis(c("Al+3", "pseudo-H4SiO4", "K+", "H2O", "H+", "O2"))
species(c("gibbsite", "muscovite", "kaolinite", "pyrophyllite", "K-feldspar"))
a <- affinity(H4SiO4 = c(-6, -2, res), `K+` = c(-3, 6, res))
diagram(a, ylab = ratlab("K+"), fill = fill, yline = 1.7)
title(main = syslab(c("K2O", "Al2O3", "SiO2", "H2O")))
legend("bottomleft", describe.property(c("T", "P"), c(25, 1)), bty = "n")
```

test blank plot
```{r fig.height=6, fig.width=6}
plot_stability_blank <- ggplot()+
  #geom_point() +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
  scale_color_continuous(name = TeX("reaction progress, $\\xi$"))+
  theme_bw()+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))#+
  #annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  #annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)

plot_stability_blank
```

test segment plot
```{r fig.height=4, fig.width=4}
plot_stability_segment <- ggplot()+
  geom_vline(xintercept = -4.68) +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
  scale_color_continuous(name = TeX("reaction progress, $\\xi$"))+
  theme_linedraw()+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))#+
  #annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  #annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)

plot_stability_segment
```

test segment plot 2
```{r fig.height=4, fig.width=4}
plot_stability_segment2 <- ggplot()+
  geom_vline(xintercept = -4.68) +
  geom_abline(intercept = -9.97, slope = -3) +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
  scale_color_continuous(name = TeX("reaction progress, $\\xi$"))+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))#+
  #annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  #annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)

plot_stability_segment2
```


```{r}
gibbs_intersect_KH <- -3*-4.68-9.97
gibbs_intersect_KH
```

test segment plot 3
```{r fig.height=4, fig.width=4}
plot_stability_segment3 <- ggplot()+
  geom_segment(aes(x = -4.68, y = gibbs_intersect_KH, xend = -4.68, yend = -3))+
  geom_segment(aes(x = -4.68, y = gibbs_intersect_KH, xend = -5.323333, yend = 6))+
  #geom_vline(xintercept = -4.68) +
  #geom_abline(intercept = -9.97, slope = -3) +
  scale_x_continuous(limits = c(-6, -2), expand = c(0, 0), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), expand = c(0, 0), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
  #scale_color_continuous(name = TeX("reaction progress, $\\xi$"))+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))#+
  #annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  #annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)

plot_stability_segment3
```

# Reaction 1: K feldspar weathering to gibbsite

KAlSi$_3$O$_8$ + H$^+$ + 7H$_2$O $\leftrightharpoons$ Al(OH)$_3$ + 2K$^+$ + 3H$_4$SiO$_4$
KAlSi$_3$O$_8$ + H$^+$ + 7H$_2$O $\leftrightharpoons$ Al(OH)$_3$ + 2K$^+$ + 3H$_4$SiO$_4$
$\text{KAlSi}_3\text{O}_8 + \text{H}^+ + 7\text{H}_2\text{O} \leftrightharpoons \text{Al(OH)}_3 + 2\text{K}^+ + 3\text{H}_4\text{SiO}_4 \space \text{(reaction 1)}$

Initial conditions, reaction 1
```{r}
#initial conditions are no secondary minerals (only primary mineral, microcline), and water chemistry of typical acidic soil
mol_gibbs_A <- 0 # moles gibbsite at t0
mol_l_H_A <- 1e-4#### ENTER PROTON CONCENTRATION OF A TYPICAL ACIDIC SOIL, pH =4  # moles per liter H+ t0
mol_l_K_A <- 1e-6 # moles per liter K+ t0
mol_l_H4SiO4_A <- 1e-6 # moles per liter H4SiO4 t0 
mol_kaol_A <- 0 # moles kaolinite t0
mol_musc_A <- 0 # moles muscovite t0

rxn_prog_var <- 7.47e-7 # reaction progress variable is proportional to the amount of reactant mineral dissolved and defines the extent of reaction. Selection of reaction progress step is arbitrary. units are moles per kg of solution

#coefficients of change for weathering of k spar to gibbsite (reaction 1)
co_spar_1 <- -1
co_H_1 <- -1
co_H2O_1 <- -7
co_gibbs_1 <- 1
co_K_1 <- 1
co_H4SiO4_1 <- 3
co_kaol_1 <- 0
co_musc_1 <- 0
```

Make data frame of reaction steps
```{r}
steps <- seq(0, 26, by = 0.01) # make a sequence of reaction steps

k_spar_to_gibbs <- as.data.frame(steps) # convert sequence to a data frame
```

Calculate geochemistry through reaction progress
```{r}
k_spar_to_gibbs <- k_spar_to_gibbs %>% mutate(mol_l_H = mol_l_H_A + co_H_1 * steps * rxn_prog_var, mol_l_K = mol_l_K_A + co_K_1 * steps * rxn_prog_var, mol_l_H4SiO4 = mol_l_H4SiO4_A + co_H4SiO4_1 * steps * rxn_prog_var, mol_gibbs = mol_gibbs_A + co_gibbs_1 * steps * rxn_prog_var, mol_kaol = mol_kaol_A + co_kaol_1 * steps * rxn_prog_var, mol_musc = mol_musc_A + co_musc_1 * steps * rxn_prog_var, log_H4SiO4 = log10(mol_l_H4SiO4), log_K_H_ratio = log10(mol_l_K/mol_l_H))
```

Plot evolution of water chemistry during k feldspar weathering to gibbsite
```{r fig.height=6, fig.width=6}
plot_k_spar_to_gibbs <- k_spar_to_gibbs %>% ggplot(aes(x=log_H4SiO4, y = log_K_H_ratio, color = steps))+
  geom_point() +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
  scale_color_continuous(name = TeX("reaction progress, $\\xi$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))+
  annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)

plot_k_spar_to_gibbs
```


#  Reaction 2: K feldspar weathering, gibbsite converted to kaolinite

KAlSi$_3$O$_8$ + 2Al(OH)$_3$ + H$^+$  $\leftrightharpoons$ 1.5Al$_2$Si$_2$O$_5$(OH)$_4$ + K$^+$ + 0.5H$_2$O

Initial conditions, reaction 2
```{r}
mol_gibbs_B <- k_spar_to_gibbs$mol_gibbs[2601] # moles gibbsite at end of reaction 1 (point B)
mol_l_H_B <-  k_spar_to_gibbs$mol_l_H[2601] # moles per liter H+ at end of reaction 1 (point B)
mol_l_K_B <- k_spar_to_gibbs$mol_l_K[2601] # moles per liter K+ at end of reaction 1 (point B)
mol_l_H4SiO4_B <- k_spar_to_gibbs$mol_l_H4SiO4[2601] # moles per liter H4SiO4 at end of reaction 1 (point B)
mol_kaol_B <- k_spar_to_gibbs$mol_kaol[2601]# moles kaolinite at end of reaction 1 (point B)
mol_musc_B <- k_spar_to_gibbs$mol_musc[2601]# moles muscovite at end of reaction 1 (point B)

# USER INPUT : coefficients of change for weathering of k spar with conversion of gibbsite to kaolinite (reaction 2)
co_spar_2 <- ##
co_H_2 <- ##
co_H2O_2 <- ##
co_gibbs_2 <- ##
co_K_2 <- ##
co_H4SiO4_2 <- ##
co_kaol_2 <- ##
co_musc_2 <- ##
```

Make data frame of reaction steps
```{r}
steps_2 <- seq(0, 20, by = 0.01)

gibbs_to_kaol <- as.data.frame(steps_2)

gibbs_to_kaol <- gibbs_to_kaol %>% mutate(steps = steps_2 + 26)
```

Calculate geochemistry through reaction progress
```{r}
gibbs_to_kaol <- gibbs_to_kaol %>% mutate(mol_l_H = mol_l_H_B + co_H_2 * steps_2 * rxn_prog_var, mol_l_K = mol_l_K_B + co_K_2 * steps_2 * rxn_prog_var, mol_l_H4SiO4 = mol_l_H4SiO4_B + co_H4SiO4_2 * steps_2 * rxn_prog_var, mol_gibbs = mol_gibbs_B + co_gibbs_2 * steps_2 * rxn_prog_var, mol_kaol = mol_kaol_B + co_kaol_2 * steps_2 * rxn_prog_var, mol_musc = mol_musc_B + co_musc_2 * steps_2 * rxn_prog_var, log_H4SiO4 = log10(mol_l_H4SiO4), log_K_H_ratio = log10(mol_l_K/mol_l_H))
```

Merge data frames for reactions 1 and 2
```{r}
gibbs_to_kaol <- gibbs_to_kaol %>% select(-steps_2)

gibbs_to_kaol <- gibbs_to_kaol %>% filter(mol_gibbs >= 0) # filter out data points where there were calculated to be negative moles gibbsite, which is impossible

reactions_1_2 <- union(k_spar_to_gibbs, gibbs_to_kaol)

```

Plot evolution of water chemistry during weathering of k feldspar with conversion of gibbsite to kaolinite (reaction 2)
```{r fig.height=6, fig.width=6}
plot_reactions_1_2 <- reactions_1_2 %>% ggplot(aes(x=log_H4SiO4, y = log_K_H_ratio, color = steps, label = mol_l_K))+
  geom_point() +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11)) +
  scale_color_continuous(name = TeX("rxn progress, $\\xi$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))+
  annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)+
  annotate("text", y = 0, x=-4.4, label = "C", size = 6)

plot_reactions_1_2
```

### STUDENT QUESTION: WHAT CHANGES IN WATER CHEMISTRY OCCUR AS GIBBSITE IS CONVERTED TO KAOLINITE? answer below


Plot accumulation of minerals with reaction progress
```{r fig.height=6, fig.width=6}
plot_minerals_rxns_1_2 <- reactions_1_2 %>% ggplot()+
  geom_point(aes(x=steps, y=mol_musc, color = "moles muscovite"))+
  geom_point(aes(x=steps, y=mol_gibbs, color = "moles gibbsite"))+
  geom_point(aes(x=steps, y=mol_kaol, color = "moles kaolinite"))+
  scale_y_continuous(name = "moles mineral in system")+
  scale_x_continuous(name = TeX("reaction progress, $\\xi$"))+
  theme_bw()

plot_minerals_rxns_1_2
```

# Reaction 3: K feldspar weathering to kaolinite

2KAlSi$_3$O$_8$ + 2H$^+$ + 9H$_2$O $\leftrightharpoons$ Al$_2$Si$_2$O$_5$(OH)$_4$ + 2K$^+$ + 4H$_4$SiO$_4$

Initial conditions, reaction 3
```{r}
mol_gibbs_C <- gibbs_to_kaol$mol_gibbs[1301] # moles gibbsite at end of reaction 2 (point C)
mol_l_H_C <-  gibbs_to_kaol$mol_l_H[1301] # moles per liter H+ at end of reaction 2 (point C)
mol_l_K_C <- gibbs_to_kaol$mol_l_K[1301] # moles per liter K+ at end of reaction 2 (point C)
mol_l_H4SiO4_C <- gibbs_to_kaol$mol_l_H4SiO4[1301] # moles per liter H4SiO4 at end of reaction 2 (point C)
mol_kaol_C <- gibbs_to_kaol$mol_kaol[1301] # moles kaolinite  at end of reaction 2 (point C)
mol_musc_C <- gibbs_to_kaol$mol_musc[1301] # moles muscovite  at end of reaction 2 (point C)

#coefficients of change for weathering of k spar to kaolinite (reaction 3)
co_spar_3 <- -2
co_H_3 <- -2
co_H2O_3 <- -9
co_gibbs_3 <- 0
co_K_3 <- 2
co_H4SiO4_3 <- 4
co_kaol_3 <- 1
co_musc_3 <- 0
```

Make data frame of reaction steps
```{r}
steps_3 <- seq(0, 100, by = 0.01)

kspar_to_kaol <- as.data.frame(steps_3)

kspar_to_kaol <- kspar_to_kaol %>% mutate(steps = steps_3 + 39)
```

Calculate geochemistry through reaction progress
```{r}
kspar_to_kaol <- kspar_to_kaol %>% mutate(mol_l_H = mol_l_H_C + co_H_3 * steps_3 * rxn_prog_var, mol_l_K = mol_l_K_C + co_K_3 * steps_3 * rxn_prog_var, mol_l_H4SiO4 = mol_l_H4SiO4_C + co_H4SiO4_3 * steps_3 * rxn_prog_var, mol_gibbs = mol_gibbs_C + co_gibbs_3 * steps_3 * rxn_prog_var, mol_kaol = mol_kaol_C + co_kaol_3 * steps_3 * rxn_prog_var, mol_musc = mol_musc_C + co_musc_3 * steps_3 * rxn_prog_var, log_H4SiO4 = log10(mol_l_H4SiO4), log_K_H_ratio = log10(mol_l_K/mol_l_H))
```

Merge data frames for reactions 1 and 2
```{r}
kspar_to_kaol <- kspar_to_kaol %>% select(-steps_3)
kspar_to_kaol <- kspar_to_kaol %>% filter(mol_l_K <= 1.01e-4) # filter out rxn steps past equilibrium

reactions_1_2_3 <- union(reactions_1_2, kspar_to_kaol)
```

Plot evolution of water chemistry during weathering of k feldspar to kaolinite (reaction 3)
```{r}
plot_reactions_1_2_3 <- reactions_1_2_3 %>% ggplot(aes(x=log_H4SiO4, y = log_K_H_ratio, color = steps, label = mol_l_K))+
  geom_point() +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11)) +
  scale_color_continuous(name = TeX("rxn progress, $\\xi$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))+
  annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)+
  annotate("text", y = 0, x=-4.4, label = "C", size = 6)+
  annotate("text", y = 4.4, x=-3.9, label = "D", size = 6)

plot_reactions_1_2_3
```

Plot accumulation of minerals with reactions 1 through 3
```{r fig.height=6, fig.width=6}
plot_minerals_rxns_1_2_3 <- reactions_1_2_3 %>% ggplot()+
  geom_point(aes(x=steps, y=mol_musc, color = "moles muscovite"))+
  geom_point(aes(x=steps, y=mol_gibbs, color = "moles gibbsite"))+
  geom_point(aes(x=steps, y=mol_kaol, color = "moles kaolinite"))+
  scale_y_continuous(name = "moles mineral in system")+
  scale_x_continuous(name = TeX("reaction progress, $\\xi$"))+
  theme_bw()

plot_minerals_rxns_1_2_3
```

# Reaction 4: K feldspar weathering with conversion of kaolinite to muscovite, reaching equilibrium between all 3 minerals

KAlSi$_3$O$_8$ + Al$_2$Si$_2$O$_5$(OH)$_4$ + 3H$_2$O $\leftrightharpoons$ KAl$_3$Si$_3$O$_{10}$(OH)$_2$ + 2H$_4$SiO$_4$

Initial conditions, reaction 4
```{r}
mol_gibbs_D <- kspar_to_kaol$mol_gibbs[4744] # moles gibbsite at end of reaction 3 (point D)
mol_l_H_D <-  kspar_to_kaol$mol_l_H[4744] # moles per liter H+ at end of reaction 3 (point D)
mol_l_K_D <- kspar_to_kaol$mol_l_K[4744] # moles per liter K+ at end of reaction 3 (point D)
mol_l_H4SiO4_D <- kspar_to_kaol$mol_l_H4SiO4[4744] # moles per liter H4SiO4 at end of reaction 3 (point D)
mol_kaol_D <- kspar_to_kaol$mol_kaol[4744] # moles kaolinite  at end of reaction 3 (point D)
mol_musc_D <- kspar_to_kaol$mol_musc[4744] # moles muscovite  at end of reaction 3 (point D)

#coefficients of change for feldspar weathering with conversion of kaolinite to muscovite (reaction 4)
co_spar_4 <- -1
co_H_4 <- 0
co_H2O_4 <- -3
co_gibbs_4 <- 0
co_K_4 <- 0
co_H4SiO4_4 <- 2
co_kaol_4 <- -1
co_musc_4 <- 1
```

Make data frame of reaction steps
```{r}
steps_4 <- seq(0, 30, by = 0.01)

kspar_to_musc <- as.data.frame(steps_4)

kspar_to_musc <- kspar_to_musc %>% mutate(steps = steps_4 + 86.39)
```

Calculate geochemistry through reaction progress
```{r}
kspar_to_musc <- kspar_to_musc %>% mutate(mol_l_H = mol_l_H_D + co_H_4 * steps_4 * rxn_prog_var, mol_l_K = mol_l_K_D + co_K_4 * steps_4 * rxn_prog_var, mol_l_H4SiO4 = mol_l_H4SiO4_D + co_H4SiO4_4 * steps_4 * rxn_prog_var, mol_gibbs = mol_gibbs_D + co_gibbs_4 * steps_4 * rxn_prog_var, mol_kaol = mol_kaol_D + co_kaol_4 * steps_4 * rxn_prog_var, mol_musc = mol_musc_D + co_musc_4 * steps_4 * rxn_prog_var, log_H4SiO4 = log10(mol_l_H4SiO4), log_K_H_ratio = log10(mol_l_K/mol_l_H))
```

Merge data frames for reactions 1, 2, 3, and 4
```{r}
kspar_to_musc <- kspar_to_musc %>% select(-steps_4)
kspar_to_musc <- kspar_to_musc %>% filter(steps <= 100) # filter out rxn steps past equilibrium

reactions_1_2_3_4 <- union(reactions_1_2_3, kspar_to_musc)
```

Plot evolution of water chemistry during K feldspar weathering with conversion of kaolinite to muscovite, reaching equilibrium between all 3 minerals
```{r}
plot_reactions_1_2_3_4 <- reactions_1_2_3_4 %>% ggplot(aes(x=log_H4SiO4, y = log_K_H_ratio, color = steps, label = mol_l_K))+
  geom_point() +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11)) +
  scale_color_continuous(name = TeX("rxn progress, $\\xi$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))+
  annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)+
  annotate("text", y = 0, x=-4.4, label = "C", size = 6)+
  annotate("text", y = 4.4, x=-3.9, label = "D", size = 6)+
  annotate("text", y = 4.4, x=-3.5, label = "E", size = 6)

plot_reactions_1_2_3_4
```

Plot accumulation of minerals with reactions 1 through 4
```{r fig.height=6, fig.width=6}
plot_minerals_rxns_1_2_3_4 <- reactions_1_2_3_4 %>% ggplot()+
  geom_point(aes(x=steps, y=mol_musc, color = "moles muscovite"))+
  geom_point(aes(x=steps, y=mol_gibbs, color = "moles gibbsite"))+
  geom_point(aes(x=steps, y=mol_kaol, color = "moles kaolinite"))+
  scale_y_continuous(name = "moles mineral in system")+
  scale_x_continuous(name = TeX("reaction progress, $\\xi$"))+
  theme_bw()

plot_minerals_rxns_1_2_3_4
```

# JHR Plots

Goals:
+ Animate the changing concentrations with reaction progress
+ Make plots interactive

Issues:
+ Looked hard for animation options coming out of ggplot and didn't find anything good. Only options are in dev mode and are glitchy.
+ Was able to do animations with plotly, but had to start plots over, so there are formatting issues (e.g. can't get TeX to work) that I'm not familiar with.
+ Animated/interactive plots are slow, so I subsetted the data. Doesn't seem like it subset very evenly though - will have to check that out.


Plot evolution of water chemistry during K feldspar weathering with conversion of kaolinite to muscovite, reaching equilibrium between all 3 minerals
(Interactive (plotly) version of Dan's plot - would need to format)
```{r fig.height=6, fig.width=6}
plot_reactions_1_2_3_4 <- reactions_1_2_3_4 %>% ggplot(aes(x=log_H4SiO4, y = log_K_H_ratio, color = steps, label = mol_l_K))+
  geom_point()

ggplotly(plot_reactions_1_2_3_4)
```

Plot accumulation of minerals with reaction progress *as stacked bar plot*
```{r fig.height=6, fig.width=6}
# To make this plot faster, I selected every tenth data point and increased the width of the bars to fill in the gaps.
plot_minerals_rxns_1_2_3_4_stacked <- reactions_1_2_3_4 %>% 
  dplyr::slice(seq(1, n(), by = 10)) %>% # default "slice" is from CHNOSZ package
  gather(key = "phase", value = "moles", starts_with("mol_")) %>% 
  ggplot() +
  aes(x = steps, y = moles, fill = phase) +
  geom_bar(stat = "identity", position = "fill", width = 1)

ggplotly(plot_minerals_rxns_1_2_3_4_stacked)
```

Plots together
```{r}
subplot(
  ggplotly(plot_minerals_rxns_1_2_3_4_stacked),
  ggplotly(plot_reactions_1_2_3_4)
)
```





Animation of species concentrations changing with reaction progress
Issues:
+ Formatting - title and axes labels aren't showing up, TeX
+ Bar plot is weirdly blinking?
```{r}

plot_reactions_1_2_3_4_anim <- reactions_1_2_3_4 %>% 
  dplyr::slice(seq(1, n(), by = 100)) %>% # select only every 100th point. Default "slice" is from CHNOSZ package
  arrange(log_H4SiO4) %>% 
  plot_ly() %>% 
  add_trace(x = ~log_H4SiO4, 
            y = ~log_K_H_ratio, 
            mode = "lines+markers", 
            marker = list(color = "black"), 
            line = list(color = "black")) %>%
  add_trace(x = ~log_H4SiO4, y = ~log_K_H_ratio, frame = ~steps, marker = list(color = "red")) %>%
  layout(title = "Concentrations",
         xaxis = list(title = "Phase", range = c(-6, -3)),
         yaxis = list(title = "-log_x", range = c(-3, 5)))


plot_minerals_rxns_1_2_3_4_anim <- reactions_1_2_3_4 %>% 
  dplyr::slice(seq(1, n(), by = 100)) %>% # select only every 100th point. Default "slice" is from CHNOSZ package
  gather(key = "phase", value = "moles", starts_with("mol_")) %>% 
  plot_ly() %>%
  add_trace(x = ~phase, 
            y = ~moles, 
            type = 'bar', 
            frame = ~steps, 
            color = ~phase) %>%
  layout(title = "Concentrations",
         xaxis = list(title = "Phase"),
         yaxis = list(title = "Moles", range = c(0, 2.3*10^-4)))



subplot(plot_reactions_1_2_3_4_anim, plot_minerals_rxns_1_2_3_4_anim, nrows = 2) %>% 
  animation_opts(500, transition = 0, redraw = TRUE)
```





Other avenues: Mostly not working


Cumulative animation option - the "r" plot mostly works, but this would take some work to get both together.
```{r}
# Following the code from https://plot.ly/ggplot2/cumulative-animations/
accumulate_by <- function(dat, var) {
  var <- lazyeval::f_eval(var, dat)
  lvls <- plotly:::getLevels(var)
  dats <- lapply(seq_along(lvls), function(x) {
    cbind(dat[var %in% lvls[seq(1, x)], ], frame = lvls[[x]])
  })
  dplyr::bind_rows(dats)
}
# 
# p <- reactions_1_2_3_4 %>% 
#   dplyr::slice(seq(1, n(), by = 100)) %>% # default "slice" is from CHNOSZ package
#   gather(key = "phase", value = "moles", starts_with("mol_")) %>% 
#   plot_ly() %>%
#   add_trace(x = ~phase, y = ~moles, type = 'bar', frame = ~steps, color = ~phase) %>%
#   layout(title = "Concentrations",
#          xaxis = list(title = "Phase"),
#          yaxis = list(title = "Moles", range = c(0, 10^-4)))
# 
r <- reactions_1_2_3_4 %>%
  dplyr::slice(seq(1, n(), by = 100)) %>% # default "slice" is from CHNOSZ package
  arrange(log_H4SiO4) %>%
  accumulate_by(~log_H4SiO4) %>%
  plot_ly() %>%
  add_trace(x = ~log_H4SiO4, y = ~log_K_H_ratio, frame = ~frame, type = 'scatter',
    mode = 'lines+markers',
    line = list(simplyfy = F)) %>%
  layout(title = "Concentrations",
         xaxis = list(title = "Phase", range = c(-6, 0)),
         yaxis = list(title = "-log_x", range = c(-2, 0)))

# This currently doesn't work as p animates by steps and r animates by frame
# subplot(p, r) %>% animation_opts(500, transition = 100, redraw = TRUE)
```




JHR - Plot accumulation of minerals with reaction progress as bar plot using gganimate
```{r fig.height=6, fig.width=6}
# # This is slow and glitchy and only outputs as a gif --> bad solution.
# library(gganimate) # ggplotly can't animate bar plots yet :/
# 
# reactions_1_2 %>% dplyr::slice(1:4)
# 
# plot_minerals_rxns_1_2_anim <- reactions_1_2 %>% 
#   dplyr::slice(seq(1, n(), by = 100)) %>% # default "slice" is from CHNOSZ package
#   gather(key = "phase", value = "moles", starts_with("mol_")) %>% 
#   ggplot() +
#   aes(x = phase, y = moles, fill = phase, frame = steps) +
#   geom_bar(stat = "identity") +
#   transition_states(
#     steps,
#     transition_length = 0.01,
#     state_length = 0.1
#   )
#   
# 
# 
# animate(plot_minerals_rxns_1_2_anim)
# 
# 
#   
#   ggplot()+
#   geom_point(aes(x=steps, y=mol_musc, color = "moles muscovite"))+
#   geom_point(aes(x=steps, y=mol_gibbs, color = "moles gibbsite"))+
#   geom_point(aes(x=steps, y=mol_kaol, color = "moles kaolinite"))+
#   scale_y_continuous(name = "moles mineral in system")+
#   scale_x_continuous(name = TeX("reaction progress, $\\xi$"))+
#   theme_bw()
# 
# ggplotly(plot_minerals_rxns_1_2_anim)
```





JHR - Plot accumulation of minerals with reaction progress as area chart - not currently working
```{r fig.height=6, fig.width=6}
# plot_minerals_rxns_1_2_3_4_area <- reactions_1_2_3_4 %>% 
#   ggplot() +
#   geom_area(aes(x=steps, y=mol_musc + mol_gibbs + mol_kaol, fill = "moles muscovite"))+
#   geom_area(aes(x=steps, y=mol_gibbs + mol_kaol, fill = "moles gibbsite"))+
#   geom_area(aes(x=steps, y=mol_kaol, fill = "moles kaolinite"))+
#   scale_y_continuous(name = "moles mineral in system")+
#   scale_x_continuous(name = "reaction progress, $\\xi$")+
#   theme_bw()
# 
# ggplotly(plot_minerals_rxns_1_2_3_4_area)
```

##STUDENT QUESTION: Using the same phase diagram, draw out the pathway you expect the water chemistry to take if we start with _____ and _____. Draw this on your phase diagram given to you in class and turn it in. 
