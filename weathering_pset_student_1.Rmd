---
title: "Mineral Stability Diagrams: K Feldspar Weathering"
output:
  html_document:
    css: stylesheet.css    fig_caption: yes
    number_sections: no
    toc: yes
    toc_float: true
    toc_depth: 3
    code_folding: show
    df_print: paged
subtitle: "Source file: weathering_pset.Rmd"
editor_options:
  chunk_output_type: inline
date: "`r Sys.Date()`"
---

# Introduction
## Technical prerequisites
* none

## Conceptual prerequisites
* familiarity with mineral stability diagrams
* using log rules to linearize equilibria
* plotting in log space

## Learning goals
* plot equilibrium lines on a mineral stability diagram using R
* improve visualization of reaction paths
* connect groundwater chemistry to mineral assemblages

## Background information
Mineral stability diagrams illustrate which minerals are thermodynamically stable given specific water chemistry conditions. When a _primary mineral_, which is often igneous or metamorphic, comes into contact with a water with which it is not in thermodynamic equilibrium, it reacts (_weathers_) into a _secondary mineral_ product.

In this R markdown file, we calculate and visualize changes in water chemistry and secondary mineral assemblages as the igneous _primary mineral_ microcline (a form of potassium feldspar) reacts with a typical, mildly acidic soil water. Weathering is a ubiquitous process on Earth's surface that is of fundamental importance due to its impact on the aqueous chemistry and mineralogy, as we will observe.

By the way, R markdown documents use a productive notebook interface to weave together narrative text and code to produce elegantly formatted output. Plus, they are fully reproducible. All the cool kids are using them!

Before diving into the chemistry, let's visualize the mineral stability diagram for the $\text{K}_2\text{O} - \text{Al}_2\text{O}_3 - \text{SiO}_2 - \text{H}_2\text{O}$ system.

Woah, wait up... what are those weird money signs and brackets? That's using the $\TeX$ typesetting system to beautify equations and other science-y things. R markdown will format that when you 'knit' the document (more on that later), but for now, you can mouse over anything in money signs to display a rendered version. Try it!

First, we need to load some packages. Packages contain functions that other smarty-pants wizards wrote. That's one great thing about R: no need to re-invent the wheel. Run this code chunk by pressing the green arrow in the right hand corner of the gray box below, or move your cursor into the chunk and press Ctrl+Alt+C (Windows) command+option+C (Mac).

# Setup

```{r setup, warning=FALSE, message=FALSE}
# load libraries
library(tidyverse) # dplyr, tidyr, ggplot
library(openxlsx) # reading and writing excel file
library(knitr) # generating reports
library(plotly) # interactive plots
library(CHNOSZ) # stability diagrams
library(latex2exp) # writing compounds and greek letters in plots
data(thermo)
opts_chunk$set(
  collapse = TRUE, comment = "#>",
  dev=c("png", "pdf"), dev.args=list(pdf = list(encoding="WinAnsi", useDingbats=FALSE))
  )
```

# Mineral stability diagram for the $\text{K}_2\text{O} - \text{Al}_2\text{O}_3 - \text{SiO}_2 - \text{H}_2\text{O}$ system
Now, run the next chunk to generate the mineral stability diagram for the $\text{K}_2\text{O} - \text{Al}_2\text{O}_3 - \text{SiO}_2 - \text{H}_2\text{O}$ system.

```{r fig.width=10, fig.height=10, warning=FALSE, error=FALSE}
par(mfrow = c(2, 2))
res <- 200
fill <- "terrain"

## K2O-Al2O3-SiO2-H2O, 25 degree C, 1 bar
## Steinmann et al., 1994 (http://ccm.geoscienceworld.org/content/42/2/197)
## Garrels and Christ, p. 361 (http://www.worldcat.org/oclc/517586)
## https://wwwbrr.cr.usgs.gov/projects/GWC_coupled/phreeqc/html/final-75.html
basis(c("Al+3", "pseudo-H4SiO4", "K+", "H2O", "H+", "O2"))
species(c("gibbsite", "muscovite", "kaolinite", "pyrophyllite", "K-feldspar"))
a <- affinity(H4SiO4 = c(-6, -2, res), `K+` = c(-3, 6, res))
diagram(a, ylab = ratlab("K+"), fill = fill, yline = 1.7)
title(main = syslab(c("K2O", "Al2O3", "SiO2", "H2O")))
legend("bottomleft", describe.property(c("T", "P"), c(25, 1)), bty = "n")
```



The first step in using a mineral stability digram is making said mineral stability digram. The lines on the mineral stability digram describe regions where the two minerals are in equilibrium.

The x-axis of the diagram is $log[H_{4}SiO_{4}]$, which is silicic acid. The Y-axis in this case will be $log \frac {[K^{+}]}{[H^{+}]}$.  The Y-axis can have different cations depending on the mineral system of interest.
You should have already derived all the weathering reactions that are relevant for the phase diagram we are building. For your reference, they are listed below. The equations are written in LaTeX format. Mouse over the equation to read it more easily.


**Gibbsite to Kaolinite**
$2\text{Al}\text{(OH)}_3 + 2\text{H}_4\text{SiO}_4 \leftrightharpoons \text{Al}_3\text{Si}_2\text{O}_5\text{(OH)}_4 + 5\text{H}_2\text{O} \space  \text {,K}_{eq} \text= \text{10}^{9.35} \space \text{(reaction 2)}$
**K-feldspar to Kaolinite**
$2\text{KAlSi}_3\text{O}_8 + 2\text{H}^+ + 9\text{H}_2\text{O} \leftrightharpoons  \text{Al}_2\text{Si}_2\text{O}_5\text{(OH)}_4 + 2\text{K}^+ + 4\text{H}_{4}\text{SiO}_{4} \space \text {,K}_{eq} \text {=} \text {10}^{-5.21} \space \text{(reaction 3)}$
**Muscovite to Kaolinite**
$ 2\text{KAl}_3\text{Si}_3\text{O}_{10}\text{(OH)}_2 + 3\text{H}_2\text{O} + 2\text{H}^+ \leftrightharpoons 3\text{Al}_2\text{Si}_2\text{O}_5\text{(OH)}_4 + 2 \text {K}^+ \space \text{,K}_{eq} = \text{10}^{8.11} \space \text{(reaction 4)}$
**K-feldspar to Muscovite**
$3\text{KAlSi}_3\text{O}_8 + 2\text{H}^+ + 12\text{H}_2\text{O}  \leftrightharpoons \text{KAl}_3\text{Si}_3\text{O}_{10}\text{(OH)}_2 + 2 \text {K}^+ + 6\text{H}_{4}\text{SiO}_{4}\space \text{,K}_{eq} = \text{10}^{-11.865} \space \text{(reaction 5)}$
**Muscovite to Gibbsite**
$\text{KAl}_3\text{Si}_3\text{O}_{10}\text{(OH)}_2 + 9\text{H}_2\text{O} + \text{H}^+ \leftrightharpoons 3\text{Al}\text{(OH)}_3  + \text{K}^+ 3\text{H}_4\text{SiO}_4 \space \text{,K}_{eq} = \text{10}^{-9.97} \space \text{(reaction 6)}$

**Question 1**: Using these equations and the Keq provided, write out the equations that will make up the mineral phase diagram. Remember that the lines are in the general linear form Y = mX + b. The x-axis of the diagram is $log[H_{4}SiO_{4}]$, which is silicic acid. The Y-axis in this case will be $log \frac {[K^{+}]}{[H^{+}]}$. Turn these equations in along with your work. *It is very helpful to remember your log rules when solving these equations. There is a Exponent and Logarithm Rule Cheat Sheet in the repository for your reference.*

Now that you have successfully derived the equations necessary for the mineral phase diagram, we will use Rstudio to build the mineral phase diagram. You can absolutely build a phase diagram by hand. However, the following Rmarkdown will walk you through how to use a phase diagram to determine how water chemistry changes as a mineral weathers.

Our calculations are adapted from the model of Steinmann et al., 1994 (http://ccm.geoscienceworld.org/content/42/2/197), which were based the following assumptions:

1. The system is closed and the water/rock ratio is small. This is akin to having almost an infinite amount of rock that is able to be weathered.
2. The secondary minerals are in equilibrium with ions in the solution even though the primary minerals are not in equilibrium.
3. Temperature and pressure are constant.
4. Aluminum is conserved in the reactions.
5. The solutions remain dilute such that all activity coefficients are close to unity.
```{r fig.height=6, fig.width=6}
plot_stability_blank <- ggplot()+
  #geom_point() +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
  scale_color_continuous(name = TeX("reaction progress, $\\xi$"))+
  theme_bw()+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))#+
  #annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  #annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)

plot_stability_blank
```

test segment plot
```{r fig.height=4, fig.width=4}
plot_stability_segment <- ggplot()+
  geom_vline(xintercept = -4.68) +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
  scale_color_continuous(name = TeX("reaction progress, $\\xi$"))+
  theme_linedraw()+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))#+
  #annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  #annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)

plot_stability_segment
```

test segment plot 2
```{r fig.height=4, fig.width=4}
plot_stability_segment2 <- ggplot()+
  geom_vline(xintercept = -4.68) +
  geom_abline(intercept = -9.97, slope = -3) +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
  scale_color_continuous(name = TeX("reaction progress, $\\xi$"))+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))#+
  #annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  #annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)

plot_stability_segment2
```


```{r}
gibbs_intersect_KH <- -3*-4.68-9.97
gibbs_intersect_KH
```

test segment plot 3
```{r fig.height=4, fig.width=4}
plot_stability_segment3 <- ggplot()+
  geom_segment(aes(x = -4.68, y = gibbs_intersect_KH, xend = -4.68, yend = -3))+
  geom_segment(aes(x = -4.68, y = gibbs_intersect_KH, xend = -5.323333, yend = 6))+
  #geom_vline(xintercept = -4.68) +
  #geom_abline(intercept = -9.97, slope = -3) +
  scale_x_continuous(limits = c(-6, -2), expand = c(0, 0), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), expand = c(0, 0), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
  #scale_color_continuous(name = TeX("reaction progress, $\\xi$"))+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))#+
  #annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  #annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)

plot_stability_segment3
```

# Reaction 1: K feldspar weathering to gibbsite

We are going to start with the single mineral microcline in typical acidic soil water.
$[H_{4}SiO_{4}] = 1e^{-6}$
$[K^{+}] = 1e^{-4}]$
$pH = 4$
Remember that $ pH = -log[H^{+}]$.

When plotting the initial water chemistry point, you should notice that it sits within the gibbsite field. This indicates that microcline (K-feldspar) is NOT stable in this water chemistry.

The next question is now which weathering reaction should we use for this initial step? Well, we know that we have K-feldspar and that our water chemistry is in the gibbsite field. So, the weathering reaction we use first will be K-feldspar to Gibbsite. The following R code chunks will walk you though how this calculatin was done. While it is good to know how to do this by hand, it is easier to see the evolution using a computer to calculate each step.

**K-feldspar to Gibbsite**
$\text{KAlSi}_3\text{O}_8 + \text{H}^+ + 7\text{H}_2\text{O} \leftrightharpoons \text{Al(OH)}_3 + \text{K}^+ + 3\text{H}_4\text{SiO}_4  \space \text{(reaction 1)}$

**Question 2** Why did we not derive a phase diagram boundary line for the K-feldspar to Gibbsite reaction?

```{r}
#initial conditions are no secondary minerals (only primary mineral, microcline), and water chemistry of typical acidic soil
mol_gibbs_A <- 0 # moles gibbsite at t0
mol_l_H_A <- 1e-4 #### ENTER PROTON CONCENTRATION OF A TYPICAL ACIDIC SOIL, pH =4  # moles per liter H+ t0
mol_l_K_A <- 1e-6 # moles per liter K+ t0
mol_l_H4SiO4_A <- 1e-6 # moles per liter H4SiO4 t0
mol_kaol_A <- 0 # moles kaolinite t0
mol_musc_A <- 0 # moles muscovite t0

rxn_prog_var <- 7.47e-7 # reaction progress variable is proportional to the amount of reactant mineral dissolved and defines the extent of reaction. Selection of reaction progress step is arbitrary. units are moles per kg of solution

#coefficients of change for weathering of k spar to gibbsite (reaction 1)
co_spar_1 <- -1
co_H_1 <- -1
co_H2O_1 <- -7
co_gibbs_1 <- 1
co_K_1 <- 1
co_H4SiO4_1 <- 3
co_kaol_1 <- 0
co_musc_1 <- 0
```

Make data frame of reaction steps
```{r}
steps <- seq(0, 26, by = 0.01) # make a sequence of reaction steps

k_spar_to_gibbs <- as.data.frame(steps) # convert sequence to a data frame
```

Calculate geochemistry through reaction progress
```{r}
k_spar_to_gibbs <- k_spar_to_gibbs %>% mutate(mol_l_H = mol_l_H_A + co_H_1 * steps * rxn_prog_var, mol_l_K = mol_l_K_A + co_K_1 * steps * rxn_prog_var, mol_l_H4SiO4 = mol_l_H4SiO4_A + co_H4SiO4_1 * steps * rxn_prog_var, mol_gibbs = mol_gibbs_A + co_gibbs_1 * steps * rxn_prog_var, mol_kaol = mol_kaol_A + co_kaol_1 * steps * rxn_prog_var, mol_musc = mol_musc_A + co_musc_1 * steps * rxn_prog_var, log_H4SiO4 = log10(mol_l_H4SiO4), log_K_H_ratio = log10(mol_l_K/mol_l_H))
```

Plot evolution of water chemistry during k feldspar weathering to gibbsite
```{r fig.height=6, fig.width=6}
plot_k_spar_to_gibbs <- k_spar_to_gibbs %>% ggplot(aes(x=log_H4SiO4, y = log_K_H_ratio, color = steps))+
  geom_line(size=2, alpha =1) +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
  scale_color_continuous(name = TeX("reaction progress, $\\xi$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))+
  annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)

plot_k_spar_to_gibbs
```
**Question 3*: Look at the plot that was generated. Did potassium increase or decrease? What about silicic acid? Where did the potassium and silisic acid come from? What happened to the concentration of Gibbsite?

#  Reaction 2: K feldspar weathering, gibbsite converted to kaolinite

Now, we have some gibbsite in our system that was produced by K-feldspar weathering. However, if reaction 1 were to continue, the water chemistry would move out of the field of gibbsite stability. Yet, microcline is not in equilibrium with the water yet either. Thus, in order to approach stability with microcline, all gibbsite must be consumed (reaction 2).

KAlSi$_3$O$_8$ + 2Al(OH)$_3$ + H$^+$  $\leftrightharpoons$ 1.5Al$_2$Si$_2$O$_5$(OH)$_4$ + K$^+$ + 0.5H$_2$O

Initial conditions, reaction 2
```{r}
mol_gibbs_B <- k_spar_to_gibbs$mol_gibbs[2601] # moles gibbsite at end of reaction 1 (point B)
mol_l_H_B <-  k_spar_to_gibbs$mol_l_H[2601] # moles per liter H+ at end of reaction 1 (point B)
mol_l_K_B <- k_spar_to_gibbs$mol_l_K[2601] # moles per liter K+ at end of reaction 1 (point B)
mol_l_H4SiO4_B <- k_spar_to_gibbs$mol_l_H4SiO4[2601] # moles per liter H4SiO4 at end of reaction 1 (point B)
mol_kaol_B <- k_spar_to_gibbs$mol_kaol[2601]# moles kaolinite at end of reaction 1 (point B)
mol_musc_B <- k_spar_to_gibbs$mol_musc[2601]# moles muscovite at end of reaction 1 (point B)

# USER INPUT : coefficients of change for weathering of k spar with conversion of gibbsite to kaolinite (reaction 2)
co_spar_2 <- ##
co_H_2 <- ##
co_H2O_2 <- ##
co_gibbs_2 <- ##
co_K_2 <- ##
co_H4SiO4_2 <- ##
co_kaol_2 <- ##
co_musc_2 <- ##
```

Make data frame of reaction steps
```{r}
steps_2 <- seq(0, 20, by = 0.01)

gibbs_to_kaol <- as.data.frame(steps_2)

gibbs_to_kaol <- gibbs_to_kaol %>% mutate(steps = steps_2 + 26)
```

Calculate geochemistry through reaction progress
```{r}
gibbs_to_kaol <- gibbs_to_kaol %>% mutate(mol_l_H = mol_l_H_B + co_H_2 * steps_2 * rxn_prog_var, mol_l_K = mol_l_K_B + co_K_2 * steps_2 * rxn_prog_var, mol_l_H4SiO4 = mol_l_H4SiO4_B + co_H4SiO4_2 * steps_2 * rxn_prog_var, mol_gibbs = mol_gibbs_B + co_gibbs_2 * steps_2 * rxn_prog_var, mol_kaol = mol_kaol_B + co_kaol_2 * steps_2 * rxn_prog_var, mol_musc = mol_musc_B + co_musc_2 * steps_2 * rxn_prog_var, log_H4SiO4 = log10(mol_l_H4SiO4), log_K_H_ratio = log10(mol_l_K/mol_l_H))
```

Merge data frames for reactions 1 and 2
```{r}
gibbs_to_kaol <- gibbs_to_kaol %>% select(-steps_2)

gibbs_to_kaol <- gibbs_to_kaol %>% filter(mol_gibbs >= 0) # filter out data points where there were calculated to be negative moles gibbsite, which is impossible

reactions_1_2 <- union(k_spar_to_gibbs, gibbs_to_kaol)

```

Plot evolution of water chemistry during weathering of k feldspar with conversion of gibbsite to kaolinite (reaction 2)
```{r fig.height=6, fig.width=6}
plot_reactions_1_2 <- reactions_1_2 %>% ggplot(aes(x=log_H4SiO4, y = log_K_H_ratio, color = steps, label = mol_l_K))+
  geom_point() +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11)) +
  scale_color_continuous(name = TeX("rxn progress, $\\xi$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))+
  annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)+
  annotate("text", y = 0, x=-4.4, label = "C", size = 6)

plot_reactions_1_2
```

**Question 4** What changes in water chemistry occur as gibbsite is converted to kaolinite? How does this relate to the shape of the curve between B and C, and how it differs from the curve A to B?

Plot accumulation of minerals with reaction progress
```{r fig.height=6, fig.width=6}
plot_minerals_rxns_1_2 <- reactions_1_2 %>% ggplot()+
  geom_point(aes(x=steps, y=mol_musc, color = "moles muscovite"))+
  geom_point(aes(x=steps, y=mol_gibbs, color = "moles gibbsite"))+
  geom_point(aes(x=steps, y=mol_kaol, color = "moles kaolinite"))+
  scale_y_continuous(name = "moles mineral in system")+
  scale_x_continuous(name = TeX("reaction progress, $\\xi$"))+
  theme_bw()

plot_minerals_rxns_1_2
```

**Question 4** You have just plotted mineral abundance versus reaction progress. Why is there an inverse relationship between kaolinite and gibbsite after this point? How does this relate to your phase diagram?

# Reaction 3: K feldspar weathering to kaolinite

Now, all of our gibbsite has been reacted into kaolinite. However, K-feldspar is still not in equilibrium with the water water chemistry, and further reaction will move through the kaolinite stability field.

KAlSi$_3$O$_8$ + H$^+$ + 7H$_2$O $\leftrightharpoons$ Al(OH)$_3$ + 2K$^+$ + 3H$_4$SiO$_4$

```{r}
mol_gibbs_C <- gibbs_to_kaol$mol_gibbs[1301] # moles gibbsite at end of reaction 2 (point C)
mol_l_H_C <-  gibbs_to_kaol$mol_l_H[1301] # moles per liter H+ at end of reaction 2 (point C)
mol_l_K_C <- gibbs_to_kaol$mol_l_K[1301] # moles per liter K+ at end of reaction 2 (point C)
mol_l_H4SiO4_C <- gibbs_to_kaol$mol_l_H4SiO4[1301] # moles per liter H4SiO4 at end of reaction 2 (point C)
mol_kaol_C <- gibbs_to_kaol$mol_kaol[1301] # moles kaolinite  at end of reaction 2 (point C)
mol_musc_C <- gibbs_to_kaol$mol_musc[1301] # moles muscovite  at end of reaction 2 (point C)

#coefficients of change for weathering of k spar to kaolinite (reaction 3)
co_spar_3 <- -2
co_H_3 <- -2
co_H2O_3 <- -9
co_gibbs_3 <- 0
co_K_3 <- 2
co_H4SiO4_3 <- 4
co_kaol_3 <- 1
co_musc_3 <- 0
```

Make data frame of reaction steps
```{r}
steps_3 <- seq(0, 100, by = 0.01)

kspar_to_kaol <- as.data.frame(steps_3)

kspar_to_kaol <- kspar_to_kaol %>% mutate(steps = steps_3 + 39)
```

Calculate geochemistry through reaction progress
```{r}
kspar_to_kaol <- kspar_to_kaol %>% mutate(mol_l_H = mol_l_H_C + co_H_3 * steps_3 * rxn_prog_var, mol_l_K = mol_l_K_C + co_K_3 * steps_3 * rxn_prog_var, mol_l_H4SiO4 = mol_l_H4SiO4_C + co_H4SiO4_3 * steps_3 * rxn_prog_var, mol_gibbs = mol_gibbs_C + co_gibbs_3 * steps_3 * rxn_prog_var, mol_kaol = mol_kaol_C + co_kaol_3 * steps_3 * rxn_prog_var, mol_musc = mol_musc_C + co_musc_3 * steps_3 * rxn_prog_var, log_H4SiO4 = log10(mol_l_H4SiO4), log_K_H_ratio = log10(mol_l_K/mol_l_H))
```

Merge data frames for reactions 1 and 2
```{r}
kspar_to_kaol <- kspar_to_kaol %>% select(-steps_3)
kspar_to_kaol <- kspar_to_kaol %>% filter(mol_l_K <= 1.01e-4) # filter out rxn steps past equilibrium

reactions_1_2_3 <- union(reactions_1_2, kspar_to_kaol)
```

Plot evolution of water chemistry during weathering of k feldspar to kaolinite (reaction 3)
```{r}
plot_reactions_1_2_3 <- reactions_1_2_3 %>% ggplot(aes(x=log_H4SiO4, y = log_K_H_ratio, color = steps, label = mol_l_K))+
  geom_point() +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11)) +
  scale_color_continuous(name = TeX("rxn progress, $\\xi$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))+
  annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)+
  annotate("text", y = 0, x=-4.4, label = "C", size = 6)+
  annotate("text", y = 4.4, x=-3.9, label = "D", size = 6)

plot_reactions_1_2_3
```

Plot accumulation of minerals with reactions 1 through 3
```{r fig.height=6, fig.width=6}
plot_minerals_rxns_1_2_3 <- reactions_1_2_3 %>% ggplot()+
  geom_point(aes(x=steps, y=mol_musc, color = "moles muscovite"))+
  geom_point(aes(x=steps, y=mol_gibbs, color = "moles gibbsite"))+
  geom_point(aes(x=steps, y=mol_kaol, color = "moles kaolinite"))+
  scale_y_continuous(name = "moles mineral in system")+
  scale_x_continuous(name = TeX("reaction progress, $\\xi$"))+
  theme_bw()

plot_minerals_rxns_1_2_3
```

# Reaction 5: K feldspar weathering with conversion of kaolinite to muscovite, reaching equilibrium between all 3 minerals



KAlSi$_3$O$_8$ + Al$_2$Si$_2$O$_5$(OH)$_4$ + 3H$_2$O $\leftrightharpoons$ KAl$_3$Si$_3$O$_{10}$(OH)$_2$ + 2H$_4$SiO$_4$

Initial conditions, reaction 4
```{r}
mol_gibbs_D <- kspar_to_kaol$mol_gibbs[4744] # moles gibbsite at end of reaction 3 (point D)
mol_l_H_D <-  kspar_to_kaol$mol_l_H[4744] # moles per liter H+ at end of reaction 3 (point D)
mol_l_K_D <- kspar_to_kaol$mol_l_K[4744] # moles per liter K+ at end of reaction 3 (point D)
mol_l_H4SiO4_D <- kspar_to_kaol$mol_l_H4SiO4[4744] # moles per liter H4SiO4 at end of reaction 3 (point D)
mol_kaol_D <- kspar_to_kaol$mol_kaol[4744] # moles kaolinite  at end of reaction 3 (point D)
mol_musc_D <- kspar_to_kaol$mol_musc[4744] # moles muscovite  at end of reaction 3 (point D)

#coefficients of change for feldspar weathering with conversion of kaolinite to muscovite (reaction 4)
co_spar_4 <- -1
co_H_4 <- 0
co_H2O_4 <- -3
co_gibbs_4 <- 0
co_K_4 <- 0
co_H4SiO4_4 <- 2
co_kaol_4 <- -1
co_musc_4 <- 1
```

Make data frame of reaction steps
```{r}
steps_4 <- seq(0, 30, by = 0.01)

kspar_to_musc <- as.data.frame(steps_4)

kspar_to_musc <- kspar_to_musc %>% mutate(steps = steps_4 + 86.39)
```

Calculate geochemistry through reaction progress
```{r}
kspar_to_musc <- kspar_to_musc %>% mutate(mol_l_H = mol_l_H_D + co_H_4 * steps_4 * rxn_prog_var, mol_l_K = mol_l_K_D + co_K_4 * steps_4 * rxn_prog_var, mol_l_H4SiO4 = mol_l_H4SiO4_D + co_H4SiO4_4 * steps_4 * rxn_prog_var, mol_gibbs = mol_gibbs_D + co_gibbs_4 * steps_4 * rxn_prog_var, mol_kaol = mol_kaol_D + co_kaol_4 * steps_4 * rxn_prog_var, mol_musc = mol_musc_D + co_musc_4 * steps_4 * rxn_prog_var, log_H4SiO4 = log10(mol_l_H4SiO4), log_K_H_ratio = log10(mol_l_K/mol_l_H))
```

Merge data frames for reactions 1, 2, 3, and 4
```{r}
kspar_to_musc <- kspar_to_musc %>% select(-steps_4)
kspar_to_musc <- kspar_to_musc %>% filter(steps <= 100) # filter out rxn steps past equilibrium

reactions_1_2_3_4 <- union(reactions_1_2_3, kspar_to_musc)
```

Plot evolution of water chemistry during K feldspar weathering with conversion of kaolinite to muscovite, reaching equilibrium between all 3 minerals
```{r}
plot_reactions_1_2_3_4 <- reactions_1_2_3_4 %>% ggplot(aes(x=log_H4SiO4, y = log_K_H_ratio, color = steps, label = mol_l_K))+
  geom_point() +
  scale_x_continuous(limits = c(-6, -2), name = TeX("log $\\left[$H$_4$SiO$_4$$\\right]$"))+
   scale_y_continuous(limits = c(-3, 6), name = TeX("log $\\left[$ $\\frac{K$^+$}{H$^+$}$ $\\right]$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11)) +
  scale_color_continuous(name = TeX("rxn progress, $\\xi$"))+
 theme(axis.title.y = element_text(angle = 0, vjust = .5, size = 11))+
  annotate("text", y = -2.4, x=-6, label = "A", size = 6)+
  annotate("text", y = -1.1, x=-4.2, label = "B", size = 6)+
  annotate("text", y = 0, x=-4.4, label = "C", size = 6)+
  annotate("text", y = 4.4, x=-3.9, label = "D", size = 6)+
  annotate("text", y = 4.4, x=-3.5, label = "E", size = 6)

plot_reactions_1_2_3_4
```

Plot accumulation of minerals with reactions 1 through 4
```{r fig.height=6, fig.width=6}
plot_minerals_rxns_1_2_3_4 <- reactions_1_2_3_4 %>% ggplot()+
  geom_point(aes(x=steps, y=mol_musc, color = "moles muscovite"))+
  geom_point(aes(x=steps, y=mol_gibbs, color = "moles gibbsite"))+
  geom_point(aes(x=steps, y=mol_kaol, color = "moles kaolinite"))+
  scale_y_continuous(name = "moles mineral in system")+
  scale_x_continuous(name = TeX("reaction progress, $\\xi$"))+
  theme_bw()

plot_minerals_rxns_1_2_3_4
```

# JHR Plots

Goals:
+ Animate the changing concentrations with reaction progress
+ Make plots interactive

Issues:
+ Looked hard for animation options coming out of ggplot and didn't find anything good. Only options are in dev mode and are glitchy.
+ Was able to do animations with plotly, but had to start plots over, so there are formatting issues (e.g. can't get TeX to work) that I'm not familiar with.
+ Animated/interactive plots are slow, so I subsetted the data. Doesn't seem like it subset very evenly though - will have to check that out.


Plot evolution of water chemistry during K feldspar weathering with conversion of kaolinite to muscovite, reaching equilibrium between all 3 minerals
(Interactive (plotly) version of Dan's plot - would need to format)
```{r fig.height=6, fig.width=6}
plot_reactions_1_2_3_4 <- reactions_1_2_3_4 %>% ggplot(aes(x=log_H4SiO4, y = log_K_H_ratio, color = steps, label = mol_l_K))+
  geom_point()

ggplotly(plot_reactions_1_2_3_4)
```

Plot accumulation of minerals with reaction progress *as stacked bar plot*
```{r fig.height=6, fig.width=6}
# To make this plot faster, I selected every tenth data point and increased the width of the bars to fill in the gaps.
plot_minerals_rxns_1_2_3_4_stacked <- reactions_1_2_3_4 %>%
  dplyr::slice(seq(1, n(), by = 10)) %>% # default "slice" is from CHNOSZ package
  gather(key = "phase", value = "moles", starts_with("mol_")) %>%
  ggplot() +
  aes(x = steps, y = moles, fill = phase) +
  geom_bar(stat = "identity", position = "fill", width = 1)

ggplotly(plot_minerals_rxns_1_2_3_4_stacked)
```

Plots together
```{r}
subplot(
  ggplotly(plot_minerals_rxns_1_2_3_4_stacked),
  ggplotly(plot_reactions_1_2_3_4)
)
```





Animation of species concentrations changing with reaction progress
Issues:
+ Formatting - title and axes labels aren't showing up, TeX
+ Bar plot is weirdly blinking?
```{r}

plot_reactions_1_2_3_4_anim <- reactions_1_2_3_4 %>%
  dplyr::slice(seq(1, n(), by = 100)) %>% # select only every 100th point. Default "slice" is from CHNOSZ package
  arrange(log_H4SiO4) %>%
  plot_ly() %>%
  add_trace(x = ~log_H4SiO4,
            y = ~log_K_H_ratio,
            mode = "lines+markers",
            marker = list(color = "black"),
            line = list(color = "black")) %>%
  add_trace(x = ~log_H4SiO4, y = ~log_K_H_ratio, frame = ~steps, marker = list(color = "red")) %>%
  layout(title = "Concentrations",
         xaxis = list(title = "Phase", range = c(-6, -3)),
         yaxis = list(title = "-log_x", range = c(-3, 5)))


plot_minerals_rxns_1_2_3_4_anim <- reactions_1_2_3_4 %>%
  dplyr::slice(seq(1, n(), by = 100)) %>% # select only every 100th point. Default "slice" is from CHNOSZ package
  gather(key = "phase", value = "moles", starts_with("mol_")) %>%
  plot_ly() %>%
  add_trace(x = ~phase,
            y = ~moles,
            type = 'bar',
            frame = ~steps,
            color = ~phase) %>%
  layout(title = "Concentrations",
         xaxis = list(title = "Phase"),
         yaxis = list(title = "Moles", range = c(0, 2.3*10^-4)))



subplot(plot_reactions_1_2_3_4_anim, plot_minerals_rxns_1_2_3_4_anim, nrows = 2) %>%
  animation_opts(500, transition = 0, redraw = TRUE)
```





Other avenues: Mostly not working


Cumulative animation option - the "r" plot mostly works, but this would take some work to get both together.
```{r}
# Following the code from https://plot.ly/ggplot2/cumulative-animations/
accumulate_by <- function(dat, var) {
  var <- lazyeval::f_eval(var, dat)
  lvls <- plotly:::getLevels(var)
  dats <- lapply(seq_along(lvls), function(x) {
    cbind(dat[var %in% lvls[seq(1, x)], ], frame = lvls[[x]])
  })
  dplyr::bind_rows(dats)
}
#
# p <- reactions_1_2_3_4 %>%
#   dplyr::slice(seq(1, n(), by = 100)) %>% # default "slice" is from CHNOSZ package
#   gather(key = "phase", value = "moles", starts_with("mol_")) %>%
#   plot_ly() %>%
#   add_trace(x = ~phase, y = ~moles, type = 'bar', frame = ~steps, color = ~phase) %>%
#   layout(title = "Concentrations",
#          xaxis = list(title = "Phase"),
#          yaxis = list(title = "Moles", range = c(0, 10^-4)))
#
r <- reactions_1_2_3_4 %>%
  dplyr::slice(seq(1, n(), by = 100)) %>% # default "slice" is from CHNOSZ package
  arrange(log_H4SiO4) %>%
  accumulate_by(~log_H4SiO4) %>%
  plot_ly() %>%
  add_trace(x = ~log_H4SiO4, y = ~log_K_H_ratio, frame = ~frame, type = 'scatter',
    mode = 'lines+markers',
    line = list(simplyfy = F)) %>%
  layout(title = "Concentrations",
         xaxis = list(title = "Phase", range = c(-6, 0)),
         yaxis = list(title = "-log_x", range = c(-2, 0)))

# This currently doesn't work as p animates by steps and r animates by frame
# subplot(p, r) %>% animation_opts(500, transition = 100, redraw = TRUE)
```




JHR - Plot accumulation of minerals with reaction progress as bar plot using gganimate
```{r fig.height=6, fig.width=6}
# # This is slow and glitchy and only outputs as a gif --> bad solution.
# library(gganimate) # ggplotly can't animate bar plots yet :/
#
# reactions_1_2 %>% dplyr::slice(1:4)
#
# plot_minerals_rxns_1_2_anim <- reactions_1_2 %>%
#   dplyr::slice(seq(1, n(), by = 100)) %>% # default "slice" is from CHNOSZ package
#   gather(key = "phase", value = "moles", starts_with("mol_")) %>%
#   ggplot() +
#   aes(x = phase, y = moles, fill = phase, frame = steps) +
#   geom_bar(stat = "identity") +
#   transition_states(
#     steps,
#     transition_length = 0.01,
#     state_length = 0.1
#   )
#   
#
#
# animate(plot_minerals_rxns_1_2_anim)
#
#
#   
#   ggplot()+
#   geom_point(aes(x=steps, y=mol_musc, color = "moles muscovite"))+
#   geom_point(aes(x=steps, y=mol_gibbs, color = "moles gibbsite"))+
#   geom_point(aes(x=steps, y=mol_kaol, color = "moles kaolinite"))+
#   scale_y_continuous(name = "moles mineral in system")+
#   scale_x_continuous(name = TeX("reaction progress, $\\xi$"))+
#   theme_bw()
#
# ggplotly(plot_minerals_rxns_1_2_anim)
```





JHR - Plot accumulation of minerals with reaction progress as area chart - not currently working
```{r fig.height=6, fig.width=6}
# plot_minerals_rxns_1_2_3_4_area <- reactions_1_2_3_4 %>%
#   ggplot() +
#   geom_area(aes(x=steps, y=mol_musc + mol_gibbs + mol_kaol, fill = "moles muscovite"))+
#   geom_area(aes(x=steps, y=mol_gibbs + mol_kaol, fill = "moles gibbsite"))+
#   geom_area(aes(x=steps, y=mol_kaol, fill = "moles kaolinite"))+
#   scale_y_continuous(name = "moles mineral in system")+
#   scale_x_continuous(name = "reaction progress, $\\xi$")+
#   theme_bw()
#
# ggplotly(plot_minerals_rxns_1_2_3_4_area)
```
